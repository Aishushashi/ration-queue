<html>
<head>
  <title>Virtual Queue</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="container mt-5">
  <h1>ðŸ¥«Ration Queue TokenðŸ•›</h1>
  <p>Take a token online and get notified before your turn â€“ no need to stand in long queues.</p>

  <div class="card p-4">
    <input type="text" id="name" class="form-control mb-2" placeholder="Name">
    <input type="tel" id="phone" class="form-control mb-3" placeholder="Phone (10 digits)">

    <button onclick="generateToken()" class="btn btn-success w-100">Get Token</button>
    <button onclick="showAdmin()" class="btn btn-warning mt-2 w-100">Admin: View Queue</button>

    <div id="token-result" class="mt-3"></div>
    <div id="admin-view" class="mt-3"></div>
  </div>

  <script>
    const tokens = JSON.parse(localStorage.getItem('queue')) || [];
    let nextToken = tokens.length ? tokens[tokens.length - 1].token + 1 : 1;

    function generateToken() {
      const name  = document.getElementById('name').value;
      const phone = document.getElementById('phone').value;

      if (!name || !phone) {
        alert('Please enter name and phone');
        return;
      }

      // PHONE VALIDATION TEMPORARILY DISABLED FOR DEMO
      // const cleaned = phone.trim();
      // if (!/^d{10}$/.test(cleaned)) {
      //   alert('Please enter a valid 10-digit phone number');
      //   return;
      // }

      localStorage.setItem('lastName', name);
      localStorage.setItem('lastPhone', phone);

      const token = nextToken++;
      const entry = { token, name, phone, time: Date.now() };
      tokens.push(entry);
      localStorage.setItem('queue', JSON.stringify(tokens));

      document.getElementById('token-result').innerHTML = `
        <div class="alert alert-success">
          <h3>Token #${token}</h3>
          <p>SMS will come 30 min before your turn, ${name}</p>
          <small>Show this at ration shop</small>
        </div>
      `;

      alert(`(Demo) SMS scheduled for Token #${token} to ${phone}`);
    }

    function showAdmin() {
      const list = tokens.map(t => `
        <div>
          #${t.token} - ${t.name} (${t.phone})
          <button class="btn btn-sm btn-outline-success" onclick="markServed(${t.token})">
            Served
          </button>
        </div>
      `).join('');

      document.getElementById('admin-view').innerHTML = `
        <h4>Current Queue (${tokens.length})</h4>
        ${list || 'No one in queue'}
        <button onclick="clearQueue()" class="btn btn-danger mt-2">Reset Daily</button>
      `;
    }

    function markServed(tokenNo) {
      const idx = tokens.findIndex(t => t.token === tokenNo);
      if (idx !== -1) {
        tokens.splice(idx, 1);
        localStorage.setItem('queue', JSON.stringify(tokens));
        showAdmin();
      }
    }

    function clearQueue() {
      tokens.length = 0;
      localStorage.removeItem('queue');
      showAdmin();
    }

    window.addEventListener('load', () => {
      const savedName  = localStorage.getItem('lastName');
      const savedPhone = localStorage.getItem('lastPhone');
      if (savedName)  document.getElementById('name').value  = savedName;
      if (savedPhone) document.getElementById('phone').value = savedPhone;
    });
  </script>
</body>
</html>
